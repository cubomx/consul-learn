# [Encryption](https://www.consul.io/docs/security/encryption)

## Gossip Encryption
You just need to set an encryption key (startup, `encrypt`). If using WAN Joined DCs use the same
key. Must be 32-bytes, base64 encoded. You can use the `consul keygen` command. Gossip secures 
between nodes over UDP. Symmetric key. Shared secret.

To enable gossip encryption you should include the `encrypt` parameter

If the agents are already running, `consul reload` is not sufficient to change the gossip config.

`consul keyring` used to examine & [modify the encryption keys](https://learn.hashicorp.com/tutorials/consul/gossip-encryption-rotate) in **Consuls's gossip pools**. Uses 
are:
- Distribute new encryption keys
- Retiring old encryption keys
- Changing the keys used by the agents

To enable federation between datacenters, the gossip keys must match.

Add new key:
```sh
consul keyring -install <Key>
```

With `consul keyring -list` you can verify that a key is recognized by all the agents.

Change primary gossip encryption key:
```sh
consul keyring -use <Key>
```

Remove old key:
```sh
consul keyring -remove <Key>
```

### Configure existing Datacenter
1. Create the key with `consul keygen`
2. Modify the paremeters of each agent
  - Introduce `encrypt` block with the parameters `encrypt_verify_incoming` as false and 
  `encrypt_verify_outgoing` as false.
3. Perform a rolling update in each agent (`consul reload` or `kill -HUP <PID>` not sufficient),
restart the agent.
4. Update `encrypt_verify_outgoing` to true in each agent and perfom a last rolling update.
## RPC Encryption with TLS
Verify the authenticity of servers & clients. They must have key pairs generated by a single CA
(x509v3 extendedKeyUsage). It is used to secure RPC calls between agents.

Modes:
- `verify_outgoing`: agents verify the authencity of Consul outgoing conns.
    - Server nodes with `cert_file` and `key_file`
- `verify_server_hostname`: outgoing conns perform hostname verification. A certificate valid with
the next from `server.<DC>.<Domain>` (0.5.1+)
- `verify_incoming`: servers verify authenticity of incoming conns. Clients should have a valid
key pair `cert_file` and `key_file`.


## [Configure TLS](https://learn.hashicorp.com/tutorials/consul/tls-encryption-secure)


First you need to generate the certificates by a private authority (production), you can use [PKI secret backend](https://www.vaultproject.io/docs/secrets/pki) or, you can use built-in Consul:
```sh
consul tls ca create
```

The following files are created:
- `consul-agent-ca.pem`: public key, must be in every node
- `consul-agent-ca-key.pem`: private, used to sign certificates. This allows to run as a trusted
Consul server.

### Server certificates
You create the server certificates:
```sh
consul tls cert create -server -dc <dc_name>
```

You must continue in the same node and repeat this process until all servers have a certificate. 
The certificates contain one that has `server.\<DCName>.consul`. This certificate can help to 
prevent from compromised clients that have become server (use `verify_server_hostname`). You must
distribute the public certificate from the previous step & the 2 new files generated by this step:
- `<DCName>-server-consul-<n>.pem`: server node public certificate
- `<DCName>-server-consul-<n>.key.pem`: server node private key

So, at the end you have 3 files
- CA bundle from the previous step
- Public certificate of the node
- Private key for it

### Distribute client certificates
Two methods:
**Operator**: third-party CA or + fine grained control. 


**Auto encryption**: (1.5.2+): it uses Connect CA to generate client certificates, Consul will distribute them. Better for large DCs.
Server config:
```hcl
verify_incoming = true
verify_outgoing = true
verify_server_hostname = true
ca_file = "consul-agent-ca.pem"
cert_file = "dc1-server-consul-0.pem"
key_file = "dc1-server-consul-0-key.pem"
auto_encrypt {
  allow_tls = true
}

```

Client config:
```hcl
verify_incoming = false
verify_outgoing = true
verify_server_hostname = true
ca_file = "consul-agent-ca.pem"
auto_encrypt = {
  tls = true
}
```